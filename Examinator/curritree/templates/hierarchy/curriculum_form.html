{% extends "base.html" %}

{% block content %}
<div class="max-w-3xl mx-auto py-8">
  <div class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl overflow-hidden">
    
    <div class="p-6 bg-blue-600 dark:bg-blue-700 text-white flex items-center justify-between">
      <h2 class="text-2xl font-extrabold tracking-tight">
        {% if is_editing %} üìù Edit: {{ node.node_type }} {{ node.name }} {% else %} ‚ûï Add a {{ initial_data.node_type|default:"Board" }}  {% endif %}
      </h2>
    </div>

    <div class="p-6 sm:p-8">
      <form method="post" novalidate class="space-y-6" id="node-form">
        {% csrf_token %}

        <div>
          <label for="id_parent" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">{{ node.parent.node_type|capfirst }}</label>
          
          {% if is_editing %}
            <p class="bg-gray-200 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-400">
                {% if node.parent %}{{ node.parent.name }} ({{ node.parent.node_type }}){% else %}Root Node (No Parent){% endif %}
            </p>
            <input type="hidden" name="parent" value="{{ initial_data.parent|default:'' }}">
          
          {% elif parent_node %}
            <p class="bg-gray-200 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-400">
                {{ parent_node.name }} ({{ parent_node.node_type }})
            </p>
            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">Parent field cannot be changed when creating a new child node.</p>
            <input type="hidden" name="parent" value="{{ parent_node.pk }}">
            
          {% else %}
            <p class="text-gray-500 italic p-2.5">This will be a root node.</p>
            <input type="hidden" name="parent" value="">
          {% endif %}

          {% if errors.parent %}
            <p class="mt-1 text-xs text-red-500">{{ errors.parent }}</p>
          {% endif %}
        </div>

        <div class="group relative z-0 w-full mb-6">
          <input type="text" 
                 name="name" 
                 id="id_name" 
                 required 
                 value="{{ initial_data.name|default:'' }}"
                 class="block py-2.5 px-0 w-full text-sm text-gray-900 dark:text-white bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" 
                 placeholder=" " >
          
          <label for="id_name" class="absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 z-10 origin-[0] peer-focus:start-0 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6 rtl:peer-focus:translate-x-full rtl:peer-focus:left-auto">
            Name
          </label>
          {% if errors.name %}
            <p class="mt-1 text-xs text-red-500">{{ errors.name }}</p>
          {% endif %}
        </div>

        {% if not parent_node.node_type == 'subject' and parent_node %}
          <input type="hidden" name="node_type" value="{{ initial_data.node_type|default:'' }}">
        {% else %}
            <div>  
              <label for="id_node_type" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Type</label>
            <select name="node_type" id="id_node_type" 
                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
              <option value="">--- Select Node Type ---</option>
              {% for val, label in node_type_choices %}
                  <option value="{{ val }}" 
                          {% if initial_data.node_type == val %}selected{% endif %}>
                      {{ label }}
                  </option>
              {% endfor %}
            </select>

            {% if errors.node_type %}
            <p class="mt-1 text-xs text-red-500">{{ errors.node_type }}</p>
            {% endif %}

          </div>
        {% endif %}
          
        <div class="group relative z-0 w-full mb-6">
          <input type="number" step="1" 
                 name="order" 
                 id="id_order" 
                 value="{{ initial_data.order|default:'' }}"
                 class="block py-2.5 px-0 w-full text-sm text-gray-900 dark:text-white bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" 
                 placeholder=" ">
          
          <label for="id_order" class="absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 z-10 origin-[0] peer-focus:start-0 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6 rtl:peer-focus:translate-x-full rtl:peer-focus:left-auto">
            Order
          </label>
          {% if errors.order %}
            <p class="mt-1 text-xs text-red-500">{{ errors.order }}</p>
          {% endif %}
        </div>
        {% if initial_data.node_type == 'chapter' or initial_data.node_type == 'unit'  %}
          <div class="group relative z-0 w-full mb-6">
            <input type="text" 
                  name="marks" 
                  id="id_marks" 
                  required 
                  value="{{ initial_data.marks|default:'' }}"
                  class="block py-2.5 px-0 w-full text-sm text-gray-900 dark:text-white bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" 
                  placeholder=" " >
            
            <label for="id_marks" class="absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 z-10 origin-[0] peer-focus:start-0 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6 rtl:peer-focus:translate-x-full rtl:peer-focus:left-auto">
              Marks 
            </label>
            {% if errors.marks %}
              <p class="mt-1 text-xs text-red-500">{{ errors.marks }}</p>
            {% endif %}
          </div>
        {% endif %}

        
        <div class="space-y-4">
          <label class="block text-sm font-medium text-gray-900 dark:text-white">
            Extra Parameters 
          </label>
          
          <div id="metadata-container" class="space-y-3">
            <div class="grid grid-cols-11 gap-4 text-xs font-semibold uppercase text-gray-500 dark:text-gray-400 pb-1 border-b border-gray-200 dark:border-gray-600">
                  <div class="col-span-5">Key</div>
                  <div class="col-span-5">Value</div>
                  <div class="col-span-1"></div> </div>
              {% for key,values in parsed_metadata.items %}
                {% include 'partials/metadata_row.html' with key=key value=values readonly=False %}
              {% empty %}
                {% comment %} 
                If your JavaScript dynamically adds the first row, you may not need the 'empty' block.
                For server-side rendering, having one row if the dictionary is empty is safer.
                {% endcomment %}
                {% include 'partials/metadata_row.html' with key='' value='' readonly=False %}
              {% endfor %}
              
            </div>
          
          <button type="button" id="add-metadata-btn" class="flex items-center text-sm font-medium text-blue-600 hover:text-blue-800 dark:text-blue-500 dark:hover:text-blue-300 transition-colors">
              <i class="fa-solid fa-plus-circle mr-2"></i> Add Custom Field
          </button>
          
          {% if errors.metadata %}
            <p class="mt-1 text-xs text-red-500">{{ errors.metadata }}</p>
          {% endif %}
          
          <input type="hidden" name="metadata" id="id_metadata_json" value="{{ initial_data.metadata|default:'' }}">
          
        </div> 
        
        ---
        
        {% if errors.general %}
        <div class="p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert">
            {{ errors.general }}
        </div>
        {% endif %}

        <div class="flex justify-between items-center pt-4">
          <a href="{% url 'curritree:curriculum_list' %}" class="px-5 py-2 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700 transition-colors">
            <i class="fa-solid fa-arrow-left mr-2"></i> Cancel
          </a>
          <button type="submit" class="px-5 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-300 dark:focus:ring-green-800 transition-colors">
            <i class="fa-solid fa-save mr-2"></i> Save
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('metadata-container');
        const addButton = document.getElementById('add-metadata-btn');
        const form = document.getElementById('node-form');
        const jsonInput = document.getElementById('id_metadata_json');
        
        // Template for a new metadata row
        const newRowHtml = `
            <div class="metadata-row grid grid-cols-11 gap-4 items-center py-2 border-b border-gray-100 dark:border-gray-700 last:border-b-0">
                <input type="text" 
                       name="metadata_key[]" 
                       placeholder="Key"
                       class="col-span-5 px-3 py-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm metadata-key focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <input type="text" 
                       name="metadata_value[]" 
                       placeholder="Value"
                       class="col-span-5 px-3 py-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm metadata-value focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <button type="button" class="col-span-1 text-red-500 hover:text-red-700 delete-row-btn p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors" title="Remove Field">
                    <i class="fa-solid fa-trash text-sm"></i>
                </button>
            </div>
        `;

        // Add Row Function
        function addRow(key = '', value = '', isServerRendered = false) {
            let newRow;
            
            if (isServerRendered) {
                // Server-rendered rows are already in the DOM
                const rows = container.querySelectorAll('.metadata-row');
                newRow = rows[rows.length - 1];
            } else {
                // Create new dynamic row
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = newRowHtml.trim();
                newRow = tempDiv.firstChild;
                
                // Insert after header
                const headerRow = container.querySelector('.grid.grid-cols-11');
                if (headerRow && headerRow.nextSibling) {
                    container.insertBefore(newRow, headerRow.nextSibling);
                } else {
                    container.appendChild(newRow);
                }
            }

            const keyInput = newRow.querySelector('.metadata-key');
            const valueInput = newRow.querySelector('.metadata-value');
            const deleteButton = newRow.querySelector('.delete-row-btn');

            if (!isServerRendered) {
                keyInput.value = key;
                valueInput.value = value;
            }

            // Attach delete event listener
            if (deleteButton) {
                deleteButton.addEventListener('click', () => {
                    if (confirm('Are you sure you want to remove this field?')) {
                        newRow.remove();
                        updateMetadataJSON();
                    }
                });
            }

            // Add input listeners
            keyInput.addEventListener('input', updateMetadataJSON);
            valueInput.addEventListener('input', updateMetadataJSON);
        }

        // Update the hidden JSON input
        function updateMetadataJSON() {
            const metadata = {};
            const keyInputs = container.querySelectorAll('input[name="meta_key"]');
            const valueInputs = container.querySelectorAll('input[name="meta_value"]');
            
            // Match keys with values
            keyInputs.forEach((keyInput, index) => {
                const valueInput = valueInputs[index];
                if (keyInput && valueInput) {
                    const key = keyInput.value.trim();
                    const value = valueInput.value.trim();
                    
                    // Only include rows where the key is not empty
                    if (key) {
                        metadata[key] = value;
                    }
                }
            });
            
            // Set the value of the hidden input field
            jsonInput.value = JSON.stringify(metadata);
            // console.log('Metadata JSON updated:', jsonInput.value);
        }

        // Initialize existing metadata rows
        function initializeExistingRows() {
            // Attach events to server-rendered rows
            const serverRows = container.querySelectorAll('.metadata-row');
            serverRows.forEach((row, index) => {
                addRow('', '', true); // true means it's server-rendered
            });
            
            // If no rows exist, add one
            if (serverRows.length === 0) {
                addRow();
            } else {
                // Update JSON from existing rows
                updateMetadataJSON();
            }
        }

        // Attach Add Button Listener
        addButton.addEventListener('click', () => {
           console.log
            addRow();
            
        });

        // Form submission handler
        form.addEventListener('submit', function(e) {
            console.log('Form submitted');
            
            // Update JSON one final time
            updateMetadataJSON();
            
            // Validate JSON
            try {
                const metadata = JSON.parse(jsonInput.value || '{}');
                console.log('Final metadata to submit:', metadata);
            } catch (error) {
                console.error('Invalid JSON in metadata:', error);
                alert('Error: Invalid metadata format. Please check your key-value pairs.');
                e.preventDefault();
                return false;
            }
            
            // Form will submit normally now
            console.log('Form submitting...');
        });

        // Initialize on page load
        initializeExistingRows();
        
        // Debug: Log initial state
        console.log('Initial metadata JSON:', jsonInput.value);
    });
</script>
{% endblock %}