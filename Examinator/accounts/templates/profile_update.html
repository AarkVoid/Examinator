{% extends 'base.html' %}

{% load static %}
{% block title %}Update Profile{% endblock %}
{% block breadcrumb %}Profile Update{% endblock %}

{% load widget_tweaks %}
{% block content %}
<div class="bg-gray-50 dark:bg-gray-900 min-h-screen py-12 px-4 md:px-6 font-sans">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden">
            
            {# --- Top Banner/Header --- #}
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-8 md:p-10 flex flex-col md:flex-row items-center justify-between">
                <div class="flex items-center space-x-6">
                    {# Profile Picture Container #}
                    <div class="group relative w-24 h-24 flex-shrink-0 cursor-pointer" onclick="document.getElementById('id_pic').click()">
                        {% if profile.pic %}
                            <img id="profile-pic-preview" src="{{ profile.pic.url }}" alt="Profile Picture" class="w-full h-full rounded-full object-cover border-4 border-white mx-auto transition-all duration-300 shadow-xl group-hover:opacity-75">
                        {% else %}
                            <div id="profile-pic-preview" class="w-full h-full rounded-full bg-indigo-500 flex items-center justify-center mx-auto border-4 border-white transition-all duration-300 shadow-xl group-hover:bg-indigo-600">
                                <i class="fa-solid fa-user text-white text-3xl"></i>
                            </div>
                        {% endif %}
                        <div class="absolute inset-0 rounded-full bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300">
                            <i class="fa-solid fa-camera text-white text-xl"></i>
                        </div>
                    </div>
                    
                    <div>
                        <h1 class="text-3xl font-extrabold text-white">Edit Profile</h1>
                        <p class="text-indigo-200 mt-1">Review and update your personal and academic information.</p>
                    </div>
                </div>

                {# Score and Rank Cards (Moved from left column for cleaner layout) #}
            </div>

            {# --- Form Content Area --- #}
            <form method="POST" enctype="multipart/form-data" class="grid grid-cols-1 lg:grid-cols-3 divide-y lg:divide-y-0 lg:divide-x divide-gray-200 dark:divide-gray-700">
                {% csrf_token %}

                {# Hidden File Input for Pic #}
                <div class="hidden">
                    {{ form.pic }}
                </div>
                
                {# --- Column 1: Personal Information --- #}
                <div class="p-8 lg:col-span-2 space-y-8">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 border-b pb-3 border-gray-200 dark:border-gray-700">Personal Information</h2>

                    {# Form Errors #}
                    {% if form.non_field_errors %}
                        <div class="p-3 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-xl border border-red-300">
                            <p class="font-semibold">Please correct the following errors:</p>
                            <ul class="list-disc ml-5 mt-1">
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        
                        {# First Name (NOW form.first_name) #}
                        <div>
                            <label for="{{ form.first_name.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{ form.first_name.label }}</label>
                            {% render_field form.first_name class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm" placeholder="Your First Name" %}
                            <div class="text-sm font-medium text-red-600 dark:text-red-400 mt-1">{{ form.first_name.errors }}</div>
                        </div>
                        
                        {# Last Name (NOW form.last_name) #}
                        <div>
                            <label for="{{ form.last_name.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{ form.last_name.label }}</label>
                            {% render_field form.last_name class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm" placeholder="Your Last Name" %}
                            <div class="text-sm font-medium text-red-600 dark:text-red-400 mt-1">{{ form.last_name.errors }}</div>
                        </div>
                        
                        {# MiddleName #}
                        <div>
                            <label for="{{ form.MiddleName.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{ form.MiddleName.label }}</label>
                            {% render_field form.MiddleName class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm" placeholder="Optional Middle Name" %}
                            <div class="text-sm font-medium text-red-600 dark:text-red-400 mt-1">{{ form.MiddleName.errors }}</div>
                        </div>

                        <div>
                            <label for="{{ form.impersonation_pin.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{ form.impersonation_pin.label }}</label>
                            {% render_field form.impersonation_pin class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm" placeholder="274589" %}
                            <div class="text-sm font-medium text-red-600 dark:text-red-400 mt-1">{{ form.impersonation_pin.errors }}</div>
                        </div>

                        {# BirthDate #}
                        <div>
                            <label for="{{ form.BirthDate.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{ form.BirthDate.label }}</label>
                            {% render_field form.BirthDate class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm" type="date" %}
                            <div class="text-sm font-medium text-red-600 dark:text-red-400 mt-1">{{ form.BirthDate.errors }}</div>
                        </div>
                        
                        {# Contact #}
                        <div class="md:col-span-2">
                            <label for="{{ form.Contact.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{ form.Contact.label }}</label>
                            {% render_field form.Contact class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm" placeholder="e.g., +91 98765 43210" %}
                            <div class="text-sm font-medium text-red-600 dark:text-red-400 mt-1">{{ form.Contact.errors }}</div>
                        </div>


                        
                        {# Address (Span 2 Columns) #}
                        <div class="md:col-span-2">
                            <label for="{{ form.address.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{ form.address.label }}</label>
                            {% render_field form.address class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm h-28 resize-none" placeholder="Your full residential address..." %}
                            <div class="text-sm font-medium text-red-600 dark:text-red-400 mt-1">{{ form.address.errors }}</div>
                        </div>

                    </div>
                </div>

                {# --- Column 2: Academic Details and Actions --- #}
                <div class="p-8 space-y-8 bg-gray-50 dark:bg-gray-800/50">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 border-b pb-3 border-gray-200 dark:border-gray-700">Academic Details</h2>

                    {# Institute (Readonly via organization_profile field which is disabled in form) #}
                    <div>
                        <label for="{{ form.organization_profile.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{ form.organization_profile.label|default:"Institute / Organization" }}</label>
                        {% render_field form.organization_profile class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 cursor-not-allowed shadow-sm" %}
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">This value is managed by an administrator and cannot be changed here.</p>
                        <div class="text-sm font-medium text-red-600 dark:text-red-400 mt-1">{{ form.organization_profile.errors }}</div>
                    </div>

                    {# Academic Stream Selector (Disabled field in form) #}
                    <div>
                        <label for="{{ form.academic_stream.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{ form.academic_stream.label }}</label>
                        {% render_field form.academic_stream class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 cursor-not-allowed shadow-sm h-32" %}
                        <div class="text-sm font-medium text-red-600 dark:text-red-400 mt-1">{{ form.academic_stream.errors }}</div>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">Your academic stream is set by an administrator for content control.</p>
                    </div>
                    
                    {# Organization Groups (Disabled field in form - displaying as tags for clarity) #}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Assigned Groups</label>
                        <div class="flex flex-wrap gap-2 p-3 bg-white dark:bg-gray-700 rounded-xl border border-gray-300 dark:border-gray-600 shadow-sm cursor-not-allowed min-h-[44px]">
                            {% for group in profile.organization_groups.all %}
                                <span class="px-3 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300">
                                    {{ group.name }}
                                </span>
                            {% empty %}
                                <span class="text-sm text-gray-500 dark:text-gray-400">Not assigned to any groups.</span>
                            {% endfor %}
                        </div>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">These groups are managed by your organization's admin.</p>
                    </div>

                    
                    {# --- Action Buttons --- #}
                    <div class="pt-6 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                        <button type="submit" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg flex items-center gap-2 transition transform hover:scale-[1.02] duration-150 focus:outline-none focus:ring-4 focus:ring-indigo-500/50">
                            <i class="fa-solid fa-cloud-arrow-up"></i> Update Profile
                        </button>
                    </div>
                    
                </div>
            </form>
        </div>
    </div>
</div>


<div id="message-modal" class="fixed inset-0 z-50 hidden flex items-start justify-center pt-20 bg-black bg-opacity-50" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl overflow-hidden max-w-sm w-full mx-4 transform transition-all">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-blue-100 dark:bg-blue-900/50 rounded-full p-2">
                    <i class="fa-solid fa-circle-info text-blue-600 dark:text-blue-400 text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100" id="modal-title">Notification</h3>
                </div>
            </div>
            <div class="mt-4">
                <p class="text-sm text-gray-600 dark:text-gray-300" id="modal-message-text">
                    This is the message content.
                </p>
            </div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 text-right">
            <button type="button" id="close-modal-button" class="inline-flex justify-center rounded-lg border border-transparent bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition">
                Close
            </button>
        </div>
    </div>
</div>

<script>
    // JavaScript to link the image click with the hidden file input and handle preview
    document.addEventListener('DOMContentLoaded', function() {
        const picUpload = document.getElementById('id_pic'); 

        if (picUpload) {
            
            // Event listener for file selection
            picUpload.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const currentPreviewElement = document.getElementById('profile-pic-preview');
                        if (currentPreviewElement.tagName === 'IMG') {
                            // Update existing image source
                            currentPreviewElement.src = e.target.result;
                        } else {
                            // If it was a div (placeholder), replace it with an image
                            const container = currentPreviewElement.parentElement;
                            const newImg = document.createElement('img');
                            newImg.id = 'profile-pic-preview';
                            newImg.src = e.target.result;
                            newImg.alt = 'Profile Picture';
                            // Classes match the original img element
                            newImg.className = 'w-full h-full rounded-full object-cover border-4 border-white mx-auto transition-all duration-300 shadow-xl group-hover:opacity-75';
                            
                            // Replace the div with the new img element
                            container.replaceChild(newImg, currentPreviewElement);
                            
                            // Re-append the overlay element which was sibling to the preview element
                            const overlay = container.querySelector('.absolute');
                            if (overlay) {
                                container.appendChild(overlay);
                            }
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Modal Logic (for displaying Django messages if you adapt this part)
        const modal = document.getElementById('message-modal');
        const closeModalButton = document.getElementById('close-modal-button');

        if (closeModalButton) {
            closeModalButton.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
        }
    });
</script>
{% endblock %}