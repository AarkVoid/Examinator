{% extends 'base.html' %}
{% load static %}

{% block title %} Create Question paper{% endblock %}


{% block content %}

<div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-10 px-4 sm:px-6 lg:px-8 transition-colors duration-300">
    <div class="max-w-5xl mx-auto bg-white dark:bg-gray-800 shadow-2xl dark:shadow-none rounded-xl p-8 lg:p-10 border border-gray-100 dark:border-gray-700 relative">
        
        <div class="absolute top-4 right-4">
            <button id="theme-toggle" class="p-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 transition duration-150 shadow-md" aria-label="Toggle dark mode">
                <svg id="moon-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                <svg id="sun-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.354 7.354l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            </button>
        </div>

        <h2 class="text-3xl font-extrabold mb-8 text-gray-900 dark:text-white border-b pb-4 border-blue-100 dark:border-blue-900 flex items-center">
            <svg class="w-7 h-7 mr-3 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m-5 4h4a2 2 0 002-2v-7a2 2 0 00-2-2h-4a2 2 0 00-2 2v7a2 2 0 002 2zM7 7h10a2 2 0 012 2v10a2 2 0 01-2 2H7a2 2 0 01-2-2V9a2 2 0 012-2z"></path></svg>
            Generate Question Paper (Random Selection)
        </h2>

        <form method="post" id="questionPaperForm">
            {% csrf_token %}

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="md:col-span-2">
                    <label for="title" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Paper Title *</label>
                    <input type="text" name="title" id="title" required
                           class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-3 focus:ring-blue-500/50 focus:border-blue-600 dark:bg-gray-700 dark:text-white transition duration-150"
                           placeholder="Enter question paper title (e.g., Mid-Term Exam 2024)">
                </div>
                 <div>
                    <label for="pattern" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Paper Pattern</label>
                    <select name="pattern" id="pattern"
                            class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-3 focus:ring-blue-500/50 focus:border-blue-600 dark:bg-gray-700 dark:text-white transition duration-150 appearance-none bg-white">
                        {% for value, label in pattern_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="mb-8 p-5 bg-blue-50 dark:bg-blue-950 rounded-xl border border-blue-200 dark:border-blue-900">
                <h3 class="text-lg font-bold text-blue-800 dark:text-blue-300 mb-4">Syllabus Selection</h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Select Board / Curriculum </label>
                    <select id="root-node" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-3 focus:ring-blue-500/50 focus:border-blue-600 dark:bg-gray-700 dark:text-white transition duration-150 appearance-none bg-white">
                        <option value="">Select Board/Curriculum</option>
                        {% for node in root_nodes %}
                            <option value="{{ node.id }}">{{ node.name }} <!--({{ node.node_type|title }}) --></option>
                        {% endfor %}
                    </select>
                </div>

                <div id="hierarchy-container" class="space-y-3 mb-6"></div>

                <div id="selected-subject-container" class="hidden p-4 bg-blue-200 dark:bg-blue-800 border border-blue-300 dark:border-blue-700 rounded-lg shadow-inner">
                    <h4 class="text-sm font-medium text-blue-900 dark:text-blue-200 mb-1">Selected Subject:</h4>
                    <div id="selected-subject" class="text-blue-800 dark:text-blue-100 text-xl font-extrabold"></div>
                    <input type="hidden" id="curriculum_subject" name="curriculum_subject">
                </div>
            </div>

            <div class="mb-8">
                <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4 border-b pb-2">Select Chapters / Units for Paper</h3>
                
                <div id="chapterPlaceholder" class="text-gray-500 dark:text-gray-400 text-base p-6 border-2 border-dashed border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 rounded-xl text-center">
                    Please select a subject above to view available units and chapters.
                </div>
                
                <div id="chapterTree" class="hidden p-4 border border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-700 max-h-80 overflow-y-auto custom-scrollbar"> kabakjb </div>
            </div>

            <div class="mb-8">
                <h4 class="text-base font-semibold text-gray-800 dark:text-gray-100 mb-2">Selected Chapters & Units:</h4>
                <div id="selectedItemsList" class="min-h-[5rem] bg-white dark:bg-gray-800 border border-dashed border-blue-300 dark:border-blue-700 rounded-xl p-4 shadow-sm transition duration-300 hover:border-blue-500 flex flex-wrap content-start gap-2 text-gray-500 dark:text-gray-400 text-sm">
                    No chapters selected
                </div>
                <div id="selected_chapters_hidden_inputs" > </div>
            </div>


             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label for="total_marks" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Target Total Marks *</label>
                    <input type="number" id="total_marks" name="total_marks" value="100" min="0" required
                           class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-3 focus:ring-blue-500/50 focus:border-blue-600 dark:bg-gray-700 dark:text-white transition duration-150"
                           oninput="updateMarkTotals()">
                </div>
                <div>
                    <label for="duration_minutes" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Duration (minutes)</label>
                    <input type="number" id="duration_minutes" name="duration_minutes" value="120" min="1"
                           class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-3 focus:ring-blue-500/50 focus:border-blue-600 dark:bg-gray-700 dark:text-white transition duration-150">
                </div>
            </div>
            
            <div class="mb-8 p-5 bg-yellow-50 dark:bg-yellow-950 rounded-xl border border-yellow-200 dark:border-yellow-900">
                <h3 class="text-xl font-bold text-yellow-800 dark:text-yellow-300 mb-4">Random Question Generation Criteria</h3>
                
                <div class="mb-6">
                    <label for="difficulty_criteria" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Paper Difficulty *</label>
                    <select name="difficulty_criteria" id="difficulty_criteria" required
                            class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-3 focus:ring-yellow-500/50 focus:border-yellow-600 dark:bg-gray-700 dark:text-white transition duration-150 appearance-none bg-white">
                        {% for value, label in difficulty_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        **Balanced:** Mix of Easy/Medium/Hard. **Easy/Medium/Hard:** Only questions of that difficulty will be selected.
                    </p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Required Marks per Question Type *</label>
                    <div id="criteria_error_message" class="text-red-600 dark:text-red-400 text-sm mb-2 font-bold hidden"></div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-800 rounded-lg shadow-sm">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Question Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-1/3">Required Marks</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                {% for type_value, type_label in question_types %}
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{{ type_label }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <input type="number" 
                                               data-q-type="{{ type_value }}" 
                                               class="required-marks-input w-full border border-gray-300 dark:border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500/50 dark:bg-gray-700 dark:text-white" 
                                               value="0" min="0" 
                                               oninput="updateMarkTotals()">
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="p-4 border-t border-yellow-200 dark:border-yellow-700 mt-4 bg-yellow-100 dark:bg-yellow-900 rounded-b-xl grid grid-cols-2 gap-4">
                    <div class="font-bold text-gray-700 dark:text-gray-300">
                        Total Marks (Input field): <span id="summary_total_marks" class="text-blue-600 dark:text-blue-400">100</span>
                    </div>
                    <div class="font-bold text-gray-700 dark:text-gray-300 text-right">
                        Total Marks (Sum of Types): <span id="total_marks_from_types" class="text-red-600 dark:text-red-400">0</span>
                    </div>
                </div>
            </div>
            <input type="hidden" name="selection_criteria_json" id="selection_criteria_json">

           

            <div class="mb-8">
                <label for="instructions" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Instructions (Optional)</label>
                <textarea id="instructions" name="instructions" rows="4"
                          class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-3 focus:ring-blue-500/50 focus:border-blue-600 dark:bg-gray-700 dark:text-white transition duration-150"
                          placeholder="Enter general instructions for the students..."></textarea>
            </div>

            <div class="flex justify-end">
                <button type="submit" id="submit_button"
                        class="bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold tracking-wide px-8 py-3 rounded-xl shadow-lg hover:from-blue-700 hover:to-blue-800 transition duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-blue-500/50">
                    Create Question Paper
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
  
<script>
// --- ELEMENT REFERENCES ---
const hierarchyContainer = document.getElementById("hierarchy-container");
const selectedSubjectContainer = document.getElementById("selected-subject-container");
const curriculumSubjectInput = document.getElementById("curriculum_subject");
const chapterTree = document.getElementById("chapterTree");
const chapterPlaceholder = document.getElementById("chapterPlaceholder");
const selectedChaptersHiddenInputs = document.getElementById("selected_chapters_hidden_inputs");
const questionPaperForm = document.getElementById("questionPaperForm");

// Mark Calculation Elements
const totalMarksInput = document.getElementById('total_marks');
const summaryTotalMarksSpan = document.getElementById('summary_total_marks');
const totalMarksFromTypesSpan = document.getElementById('total_marks_from_types');
const requiredMarksInputs = document.querySelectorAll('.required-marks-input');
const criteriaErrorMessage = document.getElementById('criteria_error_message');
const selectionCriteriaJsonInput = document.getElementById('selection_criteria_json');
const submitButton = document.getElementById('submit_button');

// --- INITIAL STATE ---
let selectedChapters = new Set();
let chapterNodeMap = {};
let allNodesMap = {}; // Map to store all node details for easier traversal

// --- MARK CALCULATION & VALIDATION LOGIC (Retained) ---

function updateMarkTotals() {
    let sumOfTypes = 0;
    
    // 1. Calculate Sum of Required Marks
    requiredMarksInputs.forEach(input => {
        const marks = parseInt(input.value) || 0;
        sumOfTypes += marks;
    });

    // 2. Get Target Total Marks
    const targetTotalMarks = parseInt(totalMarksInput.value) || 0;
    
    // 3. Update Summary Spans
    summaryTotalMarksSpan.textContent = targetTotalMarks;
    totalMarksFromTypesSpan.textContent = sumOfTypes;

    // 4. Validation Check
    const isValid = targetTotalMarks > 0 && sumOfTypes > 0 && sumOfTypes === targetTotalMarks;
    
    // Apply styling and disable submit button based on validity
    if (isValid) {
        criteriaErrorMessage.classList.add('hidden');
        totalMarksFromTypesSpan.classList.remove('text-red-600', 'dark:text-red-400');
        totalMarksFromTypesSpan.classList.add('text-green-600', 'dark:text-green-400');
        submitButton.disabled = false;
        submitButton.classList.remove('opacity-50', 'cursor-not-allowed');

    } else {
        criteriaErrorMessage.classList.remove('hidden');
        if (targetTotalMarks <= 0) {
            criteriaErrorMessage.textContent = "Target Total Marks must be greater than 0.";
        } else if (sumOfTypes <= 0) {
             criteriaErrorMessage.textContent = "Total Marks from Question Types must be greater than 0.";
        } else {
            criteriaErrorMessage.textContent = `The sum of marks per type (${sumOfTypes}) must equal the Target Total Marks (${targetTotalMarks}).`;
        }
        totalMarksFromTypesSpan.classList.add('text-red-600', 'dark:text-red-400');
        totalMarksFromTypesSpan.classList.remove('text-green-600', 'dark:text-green-400');
        submitButton.disabled = true;
        submitButton.classList.add('opacity-50', 'cursor-not-allowed');
    }
}

// Initial calculation call
document.addEventListener('DOMContentLoaded', updateMarkTotals);
totalMarksInput.addEventListener('input', updateMarkTotals);
requiredMarksInputs.forEach(input => input.addEventListener('input', updateMarkTotals));

// --- DARK MODE LOGIC (Retained) ---
const themeToggle = document.getElementById('theme-toggle');
const moonIcon = document.getElementById('moon-icon');
const sunIcon = document.getElementById('sun-icon');
const htmlEl = document.documentElement;

function setTheme(mode) {
    if (mode === 'dark') {
        htmlEl.classList.add('dark');
        moonIcon.classList.remove('hidden');
        sunIcon.classList.add('hidden');
        localStorage.setItem('theme', 'dark');
    } else {
        htmlEl.classList.remove('dark');
        sunIcon.classList.remove('hidden');
        moonIcon.classList.add('hidden');
        localStorage.setItem('theme', 'light');
    }
}
(function initTheme() {
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        setTheme('dark');
    } else {
        setTheme('light');
    }
})();
themeToggle.addEventListener('click', () => {
    if (htmlEl.classList.contains('dark')) {
        setTheme('light');
    } else {
        setTheme('dark');
    }
});
// --- END DARK MODE LOGIC ---

function getColor(type) {
    const colors = {unit: 'purple', chapter: 'green', section: 'gray'};
    return colors[type] || 'blue';
}

function updateSelectedItemsList() {
    const selectedItemsList = document.getElementById("selectedItemsList");
    if (selectedChapters.size === 0) {
        selectedItemsList.innerHTML = '<span class="text-gray-500 dark:text-gray-400 italic">No chapters selected</span>';
        return;
    }
    let html = '';
    selectedChapters.forEach(id => {
        const data = chapterNodeMap[id];
        if (!data) return; // Skip if data is missing
        const colorClass = data.type === 'unit' ? 'purple' : data.type === 'chapter' ? 'green' : 'gray'; 
        
        html += `
            <span class="inline-flex items-center bg-${colorClass}-100 dark:bg-${colorClass}-900 text-${colorClass}-800 dark:text-${colorClass}-300 rounded-full px-3 py-1 text-sm font-medium transition duration-150 shadow-sm">
                ${data.name}
                <button type="button" onclick="removeSelected('${id}')"
                    class="ml-2 text-${colorClass}-600 dark:text-${colorClass}-400 hover:text-${colorClass}-900 dark:hover:text-${colorClass}-100 focus:outline-none focus:ring-2 focus:ring-${colorClass}-500 rounded-full h-4 w-4 flex items-center justify-center">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </span>`;
    });
    selectedItemsList.innerHTML = html;
    selectedChaptersHiddenInputs.innerHTML = ''; 
}

// ------------------------- NEW CASCADING LOGIC -------------------------

/**
 * Recursively checks or unchecks all descendant checkboxes and updates the global state.
 * Implements: Selecting a parent selects all children.
 * @param {HTMLElement} parentDiv - The .pl-4.mb-2 div of the parent item.
 * @param {boolean} isChecked - The desired state (true for select, false for deselect).
 */
function setChildrenChecked(parentDiv, isChecked) {
    // Find the children container: div with class 'border-l' inside parentDiv
    const childrenContainer = parentDiv.querySelector('.border-l');
    
    if (!childrenContainer) return;
    
    // Find all selectable checkboxes within the children container
    const childCheckboxes = childrenContainer.querySelectorAll('label .chapter-checkbox');
    console.log(" Child select childCheckboxes :",childCheckboxes)
    childCheckboxes.forEach(childCheckbox => {
        if (childCheckbox.checked !== isChecked) {
            childCheckbox.checked = isChecked;
            
            // Update the state in the Set/Map
            const id = childCheckbox.value;
            const name = childCheckbox.dataset.name;
            const type = childCheckbox.dataset.type;
            
            if (isChecked) {
                selectedChapters.add(id);
                chapterNodeMap[id] = {name, type};
            } else {
                selectedChapters.delete(id);
                delete chapterNodeMap[id];
            }
            
            // Recursively update children of this child
            const childDiv = childCheckbox.closest('.pl-4.mb-2');
            if (childDiv) {
                setChildrenChecked(childDiv, isChecked);
            }
        }
    });
}

/**
 * Recursively updates parent checkbox state based on the state of all its siblings.
 * Implements: Parent deselects when any single child is deselected.
 * @param {HTMLElement} childCheckbox - The checkbox that was just acted upon.
 */
function updateParentState(childCheckbox) {
    // 1. Find the container of all siblings (the .border-l div)
    const siblingsContainer = childCheckbox.closest('.pl-4.mb-2').parentElement;
    console.log("siblingsContainer :",siblingsContainer);
    if (!siblingsContainer || !siblingsContainer.classList.contains('border-l')) return;
    
    // 2. Find the grandparent container (which holds the parent checkbox)
    const grandparentDiv = siblingsContainer.parentElement;
    console.log("grandparentDiv :",grandparentDiv);
    if (!grandparentDiv) return;
    
    // 3. Find the parent checkbox inside the grandparent
    const parentLabel = grandparentDiv.querySelector('label');
    if (!parentLabel) return;
    const parentCheckbox = parentLabel.querySelector('.chapter-checkbox');
    
    // CRITICAL FIX: Check if parentCheckbox is actually a parent, not a sibling
    if (!parentCheckbox) return;
    
    // Check if parent checkbox value exists among siblings
    const allChildrenCheckboxes = siblingsContainer.querySelectorAll('label .chapter-checkbox');
    
    // Verify this is actually a parent, not just another sibling
    let isActuallyParent = true;
    allChildrenCheckboxes.forEach(childCheckbox => {
        if (childCheckbox.value === parentCheckbox.value) {
            // Found parent checkbox among children - this means it's not a real parent
            isActuallyParent = false;
        }
    });
    
    if (!isActuallyParent) {
        console.log("No real parent checkbox found, skipping parent update");
        return; // Don't update if it's not a real parent
    }
    
    console.log("parentCheckbox :",parentCheckbox, parentCheckbox.value, "parentLabel :",parentLabel);

    console.log("allChildrenCheckboxes :",allChildrenCheckboxes)

    // 4. Check current state of all siblings (only selectable elements)
    let allChecked = true;

    allChildrenCheckboxes.forEach(sibling => {
        if (!sibling.checked) {
            allChecked = false;
        }
    });

    const currentParentCheckedState = parentCheckbox.checked;
    let newParentCheckedState;

    if (allChecked) {
        // If all children are checked, check the parent and select it internally.
        newParentCheckedState = true;
    } else {
        // If even one child is unchecked, uncheck the parent and deselect it internally.
        newParentCheckedState = false; 
    }
    
    parentCheckbox.checked = newParentCheckedState;

    // 5. Update internal state if the checkbox state changed
    if (currentParentCheckedState !== newParentCheckedState) {
        const id = parentCheckbox.value;
        const name = parentCheckbox.dataset.name;
        const type = parentCheckbox.dataset.type;
        
        if (newParentCheckedState) {
            selectedChapters.add(id);
            chapterNodeMap[id] = {name, type};
        } else {
            selectedChapters.delete(id);
            delete chapterNodeMap[id];
        }

        // 6. Recursively call for the next parent up the hierarchy
        updateParentState(parentCheckbox);
    }
}

/**
 * Removes a chapter/unit from the selected list (used by the X button on the tag).
 * Triggers the deselection on the checkbox and the upward cascade.
 */
function removeSelected(id) {
    const box = document.querySelector(`input.chapter-checkbox[value="${id}"]`);
    
    if (box) {
        // Explicitly set checked to false and trigger all necessary logic
        box.checked = false;
        toggleChapterSelection(box);
    } else {
        // If element not in DOM (e.g., deleted parent, tag removed) just clean state
        selectedChapters.delete(id);
        delete chapterNodeMap[id];
        updateSelectedItemsList();
    }
}


/**
 * Toggles a chapter/unit selection (used by onchange event on the checkbox).
 * This function handles both downward and upward cascading logic.
 */
function toggleChapterSelection(checkbox) {
    const id = checkbox.value;
    const name = checkbox.dataset.name;
    const type = checkbox.dataset.type;
    const isChecked = checkbox.checked;

    // 1. Update own state (internal map/set)
    if (isChecked) {
        selectedChapters.add(id);
        chapterNodeMap[id] = {name, type};
    } else {
        selectedChapters.delete(id);
        delete chapterNodeMap[id];
    }
    
    // Find the closest parent container of the checkbox
    const currentDiv = checkbox.closest('.pl-4.mb-2'); 

    // 2. Cascading Down (Select/Deselect all children)
    if (currentDiv) {
        setChildrenChecked(currentDiv, isChecked);
    }
    
    // 3. Cascading Up (Update parent state)
    // Only cascade up if this is not a root node
    if (currentDiv.parentElement.closest('.pl-4.mb-2')) {
        updateParentState(checkbox); 
    }
    
    updateSelectedItemsList();
}

// ------------------------- END CASCADING LOGIC -------------------------


function buildChapterTree(node) {
    let html = `<div class="pl-4 mb-2">`;
    const color = getColor(node.node_type);
    const selectable = ['unit', 'chapter'].includes(node.node_type);

    // Check if the node is currently selected (for re-rendering)
    const isChecked = selectedChapters.has(String(node.id)) ? 'checked' : ''; 
    
    // Store node details globally
    allNodesMap[node.id] = node;

    if (selectable) {
        html += `
        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 rounded-lg p-1 transition duration-100">
            <input type="checkbox" class="chapter-checkbox form-checkbox h-5 w-5 text-${color}-600 rounded"
                   value="${node.id}" data-name="${node.name}" data-type="${node.node_type}"
                   onchange="toggleChapterSelection(this)" ${isChecked}>
            <span class="text-gray-700 dark:text-gray-200">${node.name}</span> <small class="text-${color}-500 dark:text-${color}-400 font-medium">(${node.node_type})</small>
        </label>`;
    } else {
        html += `<p class="text-sm text-gray-800 dark:text-gray-100 font-semibold mt-2 mb-1">${node.name}</p>`;
    }
    
    if (node.children && node.children.length > 0) {
        // Add the border-l container for children
        html += `<div class="ml-4 border-l border-gray-200 dark:border-gray-600 pl-3 mt-1">`;
        node.children.forEach(child => {
            html += buildChapterTree(child);
        });
        html += `</div>`; // Close the children container
    }
    
    html += `</div>`; // Close the main div
    return html;
}

function loadChapterTree(subjectId) {
    chapterPlaceholder.innerHTML = 'Loading chapters...';
    chapterPlaceholder.classList.remove('hidden');
    chapterTree.classList.add('hidden');
    
    // Clear state when a new subject is loaded
    selectedChapters.clear();
    chapterNodeMap = {};
    allNodesMap = {};
    updateSelectedItemsList();

    fetch(`/quiz/nodes/${subjectId}/curriculam`)
        .then(res => res.json())
        .then(data => {
            if (data.success && data.tree) {
                chapterTree.innerHTML = buildChapterTree(data.tree); // Call the new build function
                chapterTree.classList.remove('hidden');
                chapterPlaceholder.classList.add('hidden');
                
                // After initial render, the UI is consistent with the empty state.
            } else {
                chapterPlaceholder.innerHTML = 'No chapters found.';
            }
        })
        .catch(() => chapterPlaceholder.innerHTML = 'Error loading chapters.');
}

function createSelect(parentId, level) {
    fetch(`/quiz/nodes/${parentId}/children/`)
        .then(res => res.json())
        .then(data => {
            const deeperSelects = hierarchyContainer.querySelectorAll(`select[data-level]`);
            deeperSelects.forEach(sel => {
                if (parseInt(sel.dataset.level) > level) sel.parentElement.remove();
            });

            if (data.children && data.children.length > 0) {
                const nextLevel = level + 1;
                const div = document.createElement('div');
                
                // Add label for accessibility
                const label = document.createElement('label');
                label.className = "block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1";
                label.textContent = `Select ${data.children[0].node_type.charAt(0).toUpperCase() + data.children[0].node_type.slice(1)}`;

                const select = document.createElement('select');
                select.className = "w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 mt-2 focus:outline-none focus:ring-3 focus:ring-blue-500/50 focus:border-blue-600 dark:bg-gray-700 dark:text-white transition duration-150 appearance-none bg-white";
                select.dataset.level = nextLevel;
                select.innerHTML = `<option value="">Select ${data.children[0].node_type}</option>`;
                data.children.forEach(child => {
                    select.innerHTML += `<option value="${child.id}" data-type="${child.node_type}">${child.name}</option>`;
                });

                select.addEventListener('change', function() {
                    const nodeType = this.options[this.selectedIndex].dataset.type;
                    if (nodeType === 'subject') {
                        const id = this.value;
                        const name = this.options[this.selectedIndex].text;
                        document.getElementById("selected-subject").textContent = name;
                        selectedSubjectContainer.classList.remove('hidden');
                        curriculumSubjectInput.value = id;

                        // Clear selection state only when a new subject is chosen (Redundant but safe)
                        selectedChapters.clear();
                        chapterNodeMap = {};
                        updateSelectedItemsList();
                        
                        loadChapterTree(id);
                        
                        const deeperSelects = hierarchyContainer.querySelectorAll(`select[data-level]`);
                        deeperSelects.forEach(sel => {
                             if (parseInt(sel.dataset.level) > nextLevel) sel.parentElement.remove();
                        });
                    } else {
                        document.getElementById("selected-subject").textContent = '';
                        selectedSubjectContainer.classList.add('hidden');
                        chapterTree.classList.add('hidden');
                        chapterPlaceholder.classList.remove('hidden');
                        curriculumSubjectInput.value = '';
                        selectedChapters.clear();
                        chapterNodeMap = {};
                        updateSelectedItemsList();
                        if (this.value) {
                             createSelect(this.value, nextLevel);
                        } else {
                            // Clear subsequent selects if selection is reset
                            deeperSelects.forEach(sel => {
                                 if (parseInt(sel.dataset.level) > nextLevel) sel.parentElement.remove();
                            });
                        }
                    }
                });

                div.appendChild(label);
                div.appendChild(select);
                hierarchyContainer.appendChild(div);
            }
        })
        .catch(() => console.error('Error loading child nodes.'));
}

document.getElementById('root-node').addEventListener('change', function() {
    // Reset all dependent fields
    hierarchyContainer.innerHTML = '';
    document.getElementById("selected-subject").textContent = '';
    selectedSubjectContainer.classList.add('hidden');
    chapterTree.classList.add('hidden');
    chapterPlaceholder.classList.remove('hidden');
    
    selectedChapters.clear();
    chapterNodeMap = {};
    updateSelectedItemsList();
    curriculumSubjectInput.value = '';

    if (this.value) createSelect(this.value, 0);

});

// --- FINAL SUBMISSION LOGIC (Retained) ---
questionPaperForm.addEventListener('submit', function(e) {
    // Client-side validation check (runs on change, but check final state)
    updateMarkTotals(); 

    if (submitButton.disabled) {
        e.preventDefault();
        // Since we cannot use alert(), display the message via console or a temporary UI element
        console.error(criteriaErrorMessage.textContent || "Please ensure all criteria (Subject, Title, Marks) are valid before submitting.");
        return;
    }

    // 1. Prepare Chapter Hidden Inputs
    selectedChaptersHiddenInputs.innerHTML = '';
    selectedChapters.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'selectedItemsList'; 
        input.value = id;
        selectedChaptersHiddenInputs.appendChild(input);
    });

    // 2. Prepare JSON Criteria for View
    const marksPerType = {};
    requiredMarksInputs.forEach(input => {
        const type = input.dataset.qType;
        const marks = parseInt(input.value) || 0;
        if (marks > 0) {
            marksPerType[type] = marks;
        }
    });

    const criteria = {
        total_paper_marks: parseInt(totalMarksInput.value) || 0,
        difficulty_criteria: document.getElementById('difficulty_criteria').value,
        marks_per_type: marksPerType,
    };

    selectionCriteriaJsonInput.value = JSON.stringify(criteria);
    
});

</script>

{% endblock %}