{% extends 'base.html' %}
{% load static %}

{% block title %} Edit Question Paper - {{ question_paper.title }} {% endblock %}

{% block content %}
<div class="flex flex-col min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
  <main class="flex-grow py-10 px-4 sm:px-6 lg:px-8">
    <div class="max-w-5xl mx-auto bg-white dark:bg-gray-800 shadow-2xl rounded-2xl p-8 lg:p-10 border border-gray-100 dark:border-gray-700 relative overflow-hidden">

      <!-- THEME TOGGLE -->
      <div class="absolute top-4 right-4">
        <button id="theme-toggle"
                class="p-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 transition">
          <svg id="moon-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M20.354 15.354A9 9 0 018.646 3.646A9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
          </svg>
          <svg id="sun-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.354 7.354l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
          </svg>
        </button>
      </div>

      <!-- TITLE -->
      <div class="mb-10">
        <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white border-b pb-3 border-blue-100 dark:border-blue-900">
          üìù Edit Question Paper
        </h2>
        <p class="text-gray-500 dark:text-gray-400 mt-2">
          Update your paper details, curriculum, and chapters below.
        </p>
      </div>

      <form method="post" id="questionPaperForm" class="space-y-10">
        {% csrf_token %}

        <!-- Paper Title + Pattern -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Paper Title *</label>
            <input type="text" name="title" id="title" value="{{ question_paper.title }}" required
                   class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Paper Pattern</label>
            <select name="pattern" id="pattern"
                    class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500">
              {% for value, label in pattern_choices %}
                <option value="{{ value }}" {% if question_paper.pattern == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Current Curriculum -->
        <div class="p-6 bg-gradient-to-r from-blue-50 to-indigo-100 dark:from-blue-950 dark:to-indigo-900 rounded-xl border border-blue-200 dark:border-blue-800 shadow-md">
          <h3 class="text-xl font-bold text-blue-800 dark:text-blue-300 mb-4 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600 dark:text-blue-400" fill="none"
                 viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6l4 2" />
            </svg>
            Syllabus Overview
          </h3>

          {% if question_paper.curriculum_subject %}
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-gray-700 dark:text-gray-300">
            <div>
              <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Board</p>
              <p class="font-semibold text-blue-800 dark:text-blue-200">{{ question_paper.curriculum_subject.parent.parent.name }}</p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Class</p>
              <p class="font-semibold text-blue-800 dark:text-blue-200">{{ question_paper.curriculum_subject.parent.name }}</p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Subject</p>
              <p class="font-semibold text-blue-800 dark:text-blue-200">{{ question_paper.curriculum_subject.name }}</p>
            </div>
          </div>

          <div class="mt-5">
            <p class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Linked Chapters</p>
            {% if question_paper.curriculum_chapters.all %}
            <div class="flex flex-wrap gap-2">
              {% for chapter in question_paper.curriculum_chapters.all %}
                <span class="bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-100 px-3 py-1 rounded-full text-sm font-medium">
                  {{ chapter.name }}
                </span>
              {% endfor %}
            </div>
            {% else %}
            <p class="italic text-gray-500 dark:text-gray-400">No chapters linked yet.</p>
            {% endif %}
          </div>

          {% else %}
          <p class="italic text-gray-500 dark:text-gray-400">No curriculum data assigned yet.</p>
          {% endif %}
        </div>

        <!-- Editable Curriculum Tree -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
            Select Board / Curriculum 
          </label>
          <select id="root-node"
                  class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 dark:bg-gray-700 dark:text-white">
            <option value="">Select Baord/Curriculum</option>
            {% for node in root_nodes %}
              <option value="{{ node.id }}" {% if node.id == initial_subject_id %}selected{% endif %}>
                {{ node.name }} <!-- ({{ node.node_type|title }}) -->
              </option>
            {% endfor %}
          </select>

          <div id="hierarchy-container" class="space-y-3 mt-4"></div>

          <div id="selected-subject-container"
               class="{% if not question_paper.curriculum_subject %}hidden{% endif %} p-4 bg-blue-100 dark:bg-blue-900 rounded-lg mt-4">
            <h4 class="text-sm font-semibold text-blue-900 dark:text-blue-200 mb-1">Selected Subject:</h4>
            <div id="selected-subject" class="text-blue-800 dark:text-blue-100 text-lg font-extrabold">
              {% if question_paper.curriculum_subject %}
                {{ question_paper.curriculum_subject.name }}
              {% else %}
                (No Subject Selected)
              {% endif %}
            </div>
            <input type="hidden" id="curriculum_subject" name="curriculum_subject"
                   value="{{ initial_subject_id|default:'' }}">
          </div>
        </div>

        <!-- Chapters Section -->
        <div class="space-y-6">
          <div>
            <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4 border-b pb-2">Edit Chapters / Units</h3>

            <div id="chapterPlaceholder"
                 class="text-gray-500 dark:text-gray-400 text-base p-6 border-2 border-dashed border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 rounded-xl text-center">
              {% if initial_subject_id %}
                Loading chapters...
              {% else %}
                Select a subject from the hierarchy above to load chapters.
              {% endif %}
            </div>

            <div id="chapterTree"
                 class="hidden p-4 border border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-700 max-h-80 overflow-y-auto"></div>
          </div>

          <!-- Selected Chapters -->
          <div>
            <h4 class="text-base font-semibold text-gray-800 dark:text-gray-100 mb-2">Selected Chapters & Units:</h4>
            <div id="selectedItemsList"
                 class="min-h-[5rem] bg-white dark:bg-gray-800 border border-dashed border-blue-300 dark:border-blue-700 rounded-xl p-4">
              Loading...
            </div>
            <div id="selected_chapters_hidden_inputs"></div>
          </div>
        </div>

        <!-- Marks + Duration -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Total Marks</label>
            <input type="number" name="total_marks" id="total_marks" value="{{ question_paper.total_marks }}" min="0"
                   class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Duration (minutes)</label>
            <input type="number" name="duration_minutes" id="duration_minutes"
                   value="{{ question_paper.duration_minutes }}" min="1"
                   class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500">
          </div>
        </div>

        <!-- Instructions -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Instructions</label>
          <textarea name="instructions" id="instructions" rows="4"
                    class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500">{{ question_paper.instructions }}</textarea>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-end">
          <button type="submit"
                  class="bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold tracking-wide px-8 py-3 rounded-xl shadow-lg hover:scale-[1.02] transition">
            üíæ Update Question Paper
          </button>
        </div>
      </form>
    </div>
  </main>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // --- Preload Data Setup ---
    // The subject ID currently selected in the paper
    const initialSubjectId = '{{ initial_subject_id|default:'' }}';
    // The list of chapter objects currently selected in the paper, parsed from JSON
    const initialChaptersRaw = JSON.parse('{{ initial_chapters_json|safe|escapejs }}' || '[]');

    const hierarchyContainer = document.getElementById("hierarchy-container");
    const selectedSubjectContainer = document.getElementById("selected-subject-container");
    const selectedSubjectDisplay = document.getElementById("selected-subject");
    const curriculumSubjectInput = document.getElementById("curriculum_subject");
    const chapterTree = document.getElementById("chapterTree");
    const chapterPlaceholder = document.getElementById("chapterPlaceholder");
    const selectedItemsList = document.getElementById("selectedItemsList");
    const selectedChaptersHiddenInputs = document.getElementById("selected_chapters_hidden_inputs");
    const themeToggle = document.getElementById('theme-toggle');
    const moonIcon = document.getElementById('moon-icon');
    const sunIcon = document.getElementById('sun-icon');
    const htmlEl = document.documentElement;

    let selectedChapters = new Set();
    let chapterNodeMap = {};

    // 1. Initialize selectedChapters and chapterNodeMap from the preloaded data
    if (initialChaptersRaw && initialChaptersRaw.length > 0) {
        initialChaptersRaw.forEach(chapter => {
            // Ensure ID is treated as a string for consistent Set usage
            const id = chapter.id.toString(); 
            selectedChapters.add(id);
            // Use fallback 'chapter' type if not provided
            chapterNodeMap[id] = { name: chapter.name, type: chapter.node_type || 'chapter' }; 
        });
    }

    // --- DARK MODE LOGIC ---
    function setTheme(mode) {
        if (mode === 'dark') {
            htmlEl.classList.add('dark');
            moonIcon.classList.remove('hidden');
            sunIcon.classList.add('hidden');
            localStorage.setItem('theme', 'dark');
        } else {
            htmlEl.classList.remove('dark');
            sunIcon.classList.remove('hidden');
            moonIcon.classList.add('hidden');
            localStorage.setItem('theme', 'light');
        }
    }

    (function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            setTheme('dark');
        } else {
            setTheme('light');
        }
    })();

    themeToggle.addEventListener('click', () => {
        if (htmlEl.classList.contains('dark')) {
            setTheme('light');
        } else {
            setTheme('dark');
        }
    });

    // --- END DARK MODE LOGIC ---

    function getColor(type) {
        const colors = {unit: 'purple', chapter: 'green', section: 'gray'};
        return colors[type] || 'blue';
    }

    function updateSelectedItemsList() {
        if (selectedChapters.size === 0) {
            selectedItemsList.innerHTML = '<span class="text-gray-500 dark:text-gray-400 italic">No chapters selected</span>';
            return;
        }
        let html = '';
        selectedChapters.forEach(id => {
            const data = chapterNodeMap[id];
            if (!data) return;
            const colorClass = data.type === 'unit' ? 'purple' : data.type === 'chapter' ? 'green' : 'gray'; 
            
            html += `
                <span class="inline-flex items-center bg-${colorClass}-100 dark:bg-${colorClass}-900 text-${colorClass}-800 dark:text-${colorClass}-300 rounded-full px-3 py-1 text-sm font-medium transition duration-150 shadow-sm mr-2 mb-2">
                    ${data.name}
                    <button type="button" onclick="removeSelected('${id}')"
                        class="ml-2 text-${colorClass}-600 dark:text-${colorClass}-400 hover:text-${colorClass}-900 dark:hover:text-${colorClass}-100 focus:outline-none focus:ring-2 focus:ring-${colorClass}-500 rounded-full h-4 w-4 flex items-center justify-center">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </span>`;
        });
        selectedItemsList.innerHTML = html;
    }

    function removeSelected(id) {
        selectedChapters.delete(id);
        delete chapterNodeMap[id];
        const box = document.querySelector(`input.chapter-checkbox[value="${id}"]`);
        if (box) box.checked = false;
        updateSelectedItemsList();
    }

    function toggleChapterSelection(checkbox) {
        const id = checkbox.value;
        const name = checkbox.dataset.name;
        const type = checkbox.dataset.type;
        if (checkbox.checked) {
            selectedChapters.add(id);
            chapterNodeMap[id] = {name, type};
        } else {
            removeSelected(id);
        }
        updateSelectedItemsList();
    }

    // Modified: Checkboxes are now pre-checked inside buildChapterTree
    function buildChapterTree(node) {
        let html = `<div class="pl-4 mb-2">`;
        const color = getColor(node.node_type);
        const selectable = ['unit', 'chapter'].includes(node.node_type);
        if (selectable) {
            // Check if this chapter is already selected
            const checked = selectedChapters.has(node.id.toString()) ? 'checked' : ''; 
            
            html += `
            <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 rounded-lg p-1 transition duration-100">
                <input type="checkbox" class="chapter-checkbox form-checkbox h-5 w-5 text-${color}-600 rounded"
                    value="${node.id}" data-name="${node.name}" data-type="${node.node_type}"
                    onchange="toggleChapterSelection(this)" ${checked}>
                <span class="text-gray-700 dark:text-gray-200">${node.name}</span> <small class="text-${color}-500 dark:text-${color}-400 font-medium">(${node.node_type})</small>
            </label>`;
        } else {
            html += `<p class="text-sm text-gray-800 dark:text-gray-100 font-semibold mt-2 mb-1">${node.name}</p>`;
        }
        if (node.children && node.children.length > 0) {
            html += `<div class="ml-4 border-l border-gray-200 dark:border-gray-600 pl-3 mt-1">`;
            node.children.forEach(child => {
                html += buildChapterTree(child);
            });
            html += `</div>`;
        }
        html += `</div>`;
        return html;
    }

    // Modified: Removed unnecessary `isInitialLoad` parameter and `selectedChapters.clear()` logic for standard use
    function loadChapterTree(subjectId) {
        chapterPlaceholder.innerHTML = 'Loading chapters...';
        chapterPlaceholder.classList.remove('hidden');
        chapterTree.classList.add('hidden');
        
        // When changing subjects, clear selections to start fresh for the new subject
        if (subjectId !== initialSubjectId) { 
            selectedChapters.clear();
            chapterNodeMap = {};
            updateSelectedItemsList();
        }

        fetch(`/quiz/nodes/${subjectId}/curriculam`)
            .then(res => res.json())
            .then(data => {
                if (data.success && data.tree) {
                    chapterTree.innerHTML = buildChapterTree(data.tree);
                    chapterTree.classList.remove('hidden');
                    chapterPlaceholder.classList.add('hidden');
                } else {
                    chapterTree.innerHTML = '';
                    chapterPlaceholder.innerHTML = 'No chapters found for this subject.';
                }
            })
            .catch((error) => {
                console.error('Error loading chapters:', error);
                chapterTree.innerHTML = '';
                chapterPlaceholder.innerHTML = 'Error loading chapters. Please try again.';
            });
    }

    function createSelect(parentId, level) {
        fetch(`/quiz/nodes/${parentId}/children/`)
            .then(res => res.json())
            .then(data => {
                const deeperSelects = hierarchyContainer.querySelectorAll(`select[data-level]`);
                deeperSelects.forEach(sel => {
                    if (parseInt(sel.dataset.level) > level) sel.parentElement.remove();
                });

                if (data.children && data.children.length > 0) {
                    const nextLevel = level + 1;
                    const div = document.createElement('div');
                    const select = document.createElement('select');
                    select.className = "w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 mt-2 focus:outline-none focus:ring-3 focus:ring-blue-500/50 focus:border-blue-600 dark:bg-gray-700 dark:text-white transition duration-150 appearance-none bg-white";
                    select.dataset.level = nextLevel;
                    // Capitalize the node type for display
                    select.innerHTML = `<option value="">Select ${data.children[0].node_type.charAt(0).toUpperCase() + data.children[0].node_type.slice(1)}</option>`;
                    
                    data.children.forEach(child => {
                        select.innerHTML += `<option value="${child.id}" data-type="${child.node_type}">${child.name}</option>`;
                    });

                    select.addEventListener('change', function() {
                        const id = this.value;
                        const name = this.options[this.selectedIndex].text;
                        const nodeType = this.options[this.selectedIndex].dataset.type;
                        
                        // Clear subsequent selects regardless of whether a subject is chosen
                        const currentLevel = parseInt(this.dataset.level);
                        const deeperSelects = hierarchyContainer.querySelectorAll(`select[data-level]`);
                        deeperSelects.forEach(sel => {
                             if (parseInt(sel.dataset.level) > currentLevel) sel.parentElement.remove();
                        });

                        if (nodeType === 'subject') {
                            selectedSubjectContainer.classList.remove('hidden');
                            selectedSubjectDisplay.textContent = name;
                            curriculumSubjectInput.value = id;
                            loadChapterTree(id);
                        } else {
                            selectedSubjectContainer.classList.add('hidden');
                            chapterTree.classList.add('hidden');
                            chapterPlaceholder.innerHTML = 'Select a subject from the hierarchy above to load chapters.';
                            chapterPlaceholder.classList.remove('hidden');
                            curriculumSubjectInput.value = '';
                            
                            // If user is navigating higher in the hierarchy, clear previous subject's selection 
                            selectedChapters.clear();
                            chapterNodeMap = {};
                            updateSelectedItemsList();

                            if (id) {
                                createSelect(id, nextLevel);
                            }
                        }
                    });

                    div.appendChild(select);
                    hierarchyContainer.appendChild(div);
                }
            })
            .catch(() => console.error('Error loading child nodes.'));
    }

    // Event listener for the Root Node selection
    document.getElementById('root-node').addEventListener('change', function() {
        hierarchyContainer.innerHTML = '';
        selectedSubjectContainer.classList.add('hidden');
        chapterTree.classList.add('hidden');
        chapterPlaceholder.innerHTML = 'Select a subject from the hierarchy above to load chapters.';
        chapterPlaceholder.classList.remove('hidden');
        
        // Reset selections when root is changed
        selectedChapters.clear();
        chapterNodeMap = {};
        updateSelectedItemsList();
        curriculumSubjectInput.value = '';

        if (this.value) {
            createSelect(this.value, 0);
        }
    });

    // Form submission handler to dynamically add hidden inputs
    questionPaperForm.addEventListener('submit', function(e) {
        selectedChaptersHiddenInputs.innerHTML = '';
        
        // Create hidden inputs for the selected chapters (what Django expects)
        selectedChapters.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selectedItemsList'; 
            input.value = id;
            selectedChaptersHiddenInputs.appendChild(input);
        });
    });

    // --- Initialization on Page Load ---
    window.addEventListener('load', () => {
        // 1. Render the initial list of selected chapters
        updateSelectedItemsList();

        // 2. If a subject is already linked (on edit page), load its chapter tree
        if (initialSubjectId) {
            loadChapterTree(initialSubjectId); 
        }
    });
</script>
{% endblock %}
