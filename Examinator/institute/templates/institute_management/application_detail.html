{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} | EduGame{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
    /* --- CSS Variables for the Dark Theme --- */
    :root {
        --primary-accent: #4A72EC; /* Professional Blue */
        --secondary-accent: #6C8DFF; /* Lighter Blue */
        --background-dark: #1F2937; /* Very dark gray for body background */
        --card-background: #2D3748; /* Slightly lighter dark gray for cards */
        --light-text: #E5E7EB; /* Very light gray for main text */
        --medium-text: #9CA3AF; /* Muted gray for meta info */
        --border-dark: #4B5563; /* Dark border color */
        --success-color: #10B981; /* Green for success */
        --error-color: #EF4444; /* Red for errors */
        --warning-color: #FBBF24; /* Amber for warning */
        --info-color: #0EA5E9; /* Blue for info */
        --shadow-dark: rgba(0, 0, 0, 0.4);
        --shadow-medium: rgba(0, 0, 0, 0.2);
        --transition-speed: 0.3s;
    }

    /* --- Base Styles --- */
    body {
        background-color: var(--background-dark);
        font-family: 'Inter', sans-serif;
        line-height: 1.6;
        color: var(--light-text);
        margin: 0;
        padding: 20px;
    }

    .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid var(--border-dark);
    }

    .page-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--light-text);
        margin: 0;
    }

    .card {
        background-color: var(--card-background);
        border: 1px solid var(--border-dark);
        border-radius: 12px;
        box-shadow: 0 10px 25px var(--shadow-dark);
        height: 100%;
        transition: all var(--transition-speed) ease-in-out;
    }
    
    .card-header-custom {
        background-color: var(--primary-accent);
        color: var(--light-text);
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-dark);
        border-radius: 12px 12px 0 0;
        display: flex;
        align-items: center;
        gap: 1rem;
        font-weight: 600;
        font-size: 1.2rem;
    }
    
    .card-header-info { background-color: var(--info-color); }
    .card-header-success { background-color: var(--success-color); }

    .card-body {
        padding: 2rem;
    }

    /* --- Details List --- */
    .detail-list dt {
        color: var(--medium-text);
        font-weight: 500;
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
    }
    .detail-list dd {
        color: var(--light-text);
        font-weight: 400;
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
    }

    /* --- Table Styling --- */
    .table-container {
        border-radius: 12px;
        overflow-x: auto;
    }
    .table-custom {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-bottom: 0;
        text-align: left;
    }
    .table-custom thead th {
        background-color: var(--primary-accent);
        color: var(--light-text);
        padding: 15px 20px;
        font-size: 0.95rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .table-custom tbody tr {
        border-bottom: 1px solid var(--border-dark);
        transition: background-color 0.2s ease;
    }
    .table-custom tbody tr:nth-child(even) { background-color: rgba(45, 55, 72, 0.5); }
    .table-custom tbody tr:nth-child(odd) { background-color: var(--card-background); }
    .table-custom tbody td {
        padding: 15px 20px;
        font-size: 1rem;
        color: var(--light-text);
        vertical-align: middle;
    }

    /* --- Badges --- */
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.4em 0.8em;
        font-size: 0.8em;
        font-weight: 600;
        border-radius: 12px;
    }
    .bg-info-custom { background-color: var(--info-color); color: var(--light-text); }
    .bg-success-custom { background-color: var(--success-color); color: var(--light-text); }
    .bg-danger-custom { background-color: var(--error-color); color: var(--light-text); }
    .bg-warning-custom { background-color: var(--warning-color); color: #1F2937; }
    .bg-secondary-custom { background-color: var(--border-dark); color: var(--light-text); }
    .bg-dark-custom { background-color: #1A202C; color: var(--light-text); }

    /* --- Buttons --- */
    .btn {
        font-weight: 600;
        padding: 0.8rem 1.5rem;
        border-radius: 10px;
        transition: all var(--transition-speed) ease-in-out;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
    }
    .btn-outline-secondary-custom {
        border: 1px solid var(--border-dark);
        color: var(--light-text);
        background-color: transparent;
    }
    .btn-outline-secondary-custom:hover {
        background-color: var(--border-dark);
        color: var(--light-text);
    }
    .btn-success-custom {
        background-color: var(--success-color);
        color: var(--background-dark);
        border: none;
    }
    .btn-success-custom:hover {
        transform: translateY(-2px);
        background-color: #059669;
    }
    .btn-danger-custom {
        background-color: var(--error-color);
        color: var(--light-text);
        border: none;
    }
    .btn-danger-custom:hover {
        transform: translateY(-2px);
        background-color: #DC2626;
    }
    .btn-info-custom {
        background-color: var(--info-color);
        color: var(--light-text);
        border: none;
    }
    .btn-info-custom:hover {
        transform: translateY(-2px);
        background-color: #0284C7;
    }
    .btn-secondary-custom {
        background-color: var(--border-dark);
        color: var(--light-text);
        border: none;
    }
    .btn-secondary-custom:hover {
        transform: translateY(-2px);
        background-color: #4B5563;
    }

    /* --- Modals --- */
    .modal-content-custom {
        background-color: var(--card-background);
        border-radius: 12px;
        border: 1px solid var(--border-dark);
    }
    .modal-header-custom {
        border-bottom: 1px solid var(--border-dark);
        color: var(--light-text);
    }
    .modal-body-custom {
        color: var(--medium-text);
    }
    .modal-footer-custom {
        border-top: 1px solid var(--border-dark);
    }
    .form-control-custom {
        background-color: #1F2937;
        color: var(--light-text);
        border: 1px solid var(--border-dark);
        border-radius: 8px;
        padding: 0.8rem 1rem;
        transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
    }
    .form-control-custom:focus {
        border-color: var(--primary-accent);
        box-shadow: 0 0 0 3px rgba(74, 114, 236, 0.2);
        outline: none;
    }
    
    /* --- Media Queries for Responsiveness --- */
    @media (max-width: 992px) {
        .header-section { flex-direction: column; align-items: flex-start; }
        .page-title { margin-bottom: 1rem; }
    }
    @media (max-width: 768px) {
        .card-body { padding: 1.5rem; }
        .page-title { font-size: 2rem; }
        .detail-list dt, .detail-list dd { font-size: 0.9rem; }
        .table-custom thead th, .table-custom tbody td { font-size: 0.85rem; padding: 12px; }
        .btn { padding: 0.6rem 1.2rem; font-size: 0.9rem; }
        .modal-body-custom .lead { font-size: 1.1rem; }
    }
    @media (max-width: 576px) {
        .page-title { font-size: 1.8rem; }
        .btn-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .btn { width: 100%; }
        .header-section a.btn { width: auto; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">

    <div class="header-section">
        <h2 class="page-title">{{ page_title }}</h2>
        <a href="{% url 'manage_applications' %}" class="btn btn-outline-secondary-custom">
            <i class="bi bi-arrow-left me-1"></i> Back to Applications
        </a>
    </div>

    <div class="row g-4 mb-5">

        {# Student Information Card #}
        <div class="col-md-6">
            <div class="card border-start border-4" style="border-color: var(--primary-accent)!important;">
                <div class="card-header-custom" style="background-color: var(--primary-accent);">
                    <i class="bi bi-person-fill fs-4"></i>
                    <h5>Student Information</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        {% if user_profile.profile_picture %}
                            <img src="{{ user_profile.profile_picture.url }}" class="img-fluid rounded-circle border border-3 border-secondary" alt="{{ user.username }}'s Profile Picture" style="width: 120px; height: 120px; object-fit: cover;">
                        {% else %}
                            <img src="{% static 'img/default-profile.png' %}" class="img-fluid rounded-circle border border-3 border-light" alt="Default Profile Picture" style="width: 120px; height: 120px; object-fit: cover;">
                        {% endif %}
                    </div>
                    <dl class="row mb-0 detail-list">
                        <dt class="col-sm-4">Username:</dt>
                        <dd class="col-sm-8 text-break"><strong>{{ user.username }}</strong></dd>

                        <dt class="col-sm-4">Email:</dt>
                        <dd class="col-sm-8 text-break">{{ user.email }}</dd>

                        <dt class="col-sm-4">Full Name:</dt>
                        <dd class="col-sm-8">{{ user_profile.Name }} {{ user_profile.MiddleName }} {{ user_profile.Surname }}</dd>

                        <dt class="col-sm-4">Class:</dt>
                        <dd class="col-sm-8">{{ user_profile.division }}</dd>

                        <dt class="col-sm-4">Address:</dt>
                        <dd class="col-sm-8 text-break">{{ user_profile.address }}</dd>
                    </dl>
                </div>
            </div>
        </div>

        {# Institution Details Card #}
        <div class="col-md-6">
            <div class="card border-start border-4" style="border-color: var(--info-color)!important;">
                <div class="card-header-custom" style="background-color: var(--info-color);">
                    <i class="bi bi-building fs-4"></i>
                    <h5>Institution Details</h5>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="table-custom">
                            <thead>
                                <tr>
                                    <th scope="col">Institution</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Applied On</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for app in applications %}
                                <tr>
                                    <td>{{ app.institution.name }}</td>
                                    <td>
                                        {% if app.status == 'pending' %}
                                            <span class="badge bg-warning-custom"><i class="bi bi-hourglass-split me-1"></i> {{ app.status|title }}</span>
                                        {% elif app.status == 'approved' %}
                                            <span class="badge bg-success-custom"><i class="bi bi-check-circle-fill me-1"></i> {{ app.status|title }}</span>
                                        {% else %}
                                            <span class="badge bg-danger-custom"><i class="bi bi-x-circle-fill me-1"></i> {{ app.status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ app.applied_at|date:"M d, Y" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        {# Application Info Card (Full width row below) #}
        <div class="col-12">
            <div class="card border-start border-4" style="border-color: var(--success-color)!important;">
                <div class="card-header-custom" style="background-color: var(--success-color);">
                    <i class="bi bi-file-earmark-text-fill fs-4"></i>
                    <h5>Application Info</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0 detail-list">
                        <dt class="col-sm-3">Status:</dt>
                        <dd class="col-sm-9">
                            {% if application.status == 'approved' %}
                                <span class="badge bg-success-custom py-2 px-3 fs-6"><i class="bi bi-check-circle-fill me-2"></i> {{ application.status|title }}</span>
                            {% elif application.status == 'rejected' %}
                                <span class="badge bg-danger-custom py-2 px-3 fs-6"><i class="bi bi-x-circle-fill me-2"></i> {{ application.status|title }}</span>
                            {% elif application.status == 'pending' %}
                                <span class="badge bg-warning-custom py-2 px-3 fs-6"><i class="bi bi-hourglass-split me-2"></i> {{ application.status|title }}</span>
                            {% else %}
                                <span class="badge bg-secondary-custom py-2 px-3 fs-6">{{ application.status|title }}</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-3">Passkey Attempt:</dt>
                        <dd class="col-sm-9">
                            {% if application.passkey_attempt %}
                                <span class="badge bg-success-custom"><i class="fas fa-check"></i> Yes</span>
                            {% else %}
                                <span class="badge bg-danger-custom"><i class="fas fa-times"></i> No</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-3">Submitted On:</dt>
                        <dd class="col-sm-9">{{ application.applied_at|date:"F j, Y P" }}</dd>

                        {% if application.reviewed_by %}
                            <dt class="col-sm-3">Reviewed By:</dt>
                            <dd class="col-sm-9">{{ reviewer.username }}</dd>

                            <dt class="col-sm-3">Reviewed At:</dt>
                            <dd class="col-sm-9">{{ application.reviewed_at|date:"F j, Y P" }}</dd>

                            <dt class="col-sm-3">Admin Notes:</dt>
                            <dd class="col-sm-9">
                                {% if application.admin_notes %}
                                    <p class="mb-0">{{ application.admin_notes|linebreaksbr }}</p>
                                {% else %}
                                    <em class="text-muted">None</em>
                                {% endif %}
                            </dd>
                        {% endif %}
                    </dl>
                </div>
            </div>
        </div>

        {# Action Buttons for Admin/Reviewer #}
        {% if perms.institute.change_application %}
            <div class="col-12 mt-4 text-center">
                {% if application.status == 'pending' %}
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success-custom btn-lg me-2" data-bs-toggle="modal" data-bs-target="#approveModal">
                            <i class="bi bi-check-circle-fill me-2"></i> Approve
                        </button>
                        <button type="button" class="btn btn-danger-custom btn-lg" data-bs-toggle="modal" data-bs-target="#rejectModal">
                            <i class="bi bi-x-circle-fill me-2"></i> Reject
                        </button>
                    </div>
                {% elif application.status == 'approved' %}
                    <button type="button" class="btn btn-info-custom btn-lg" data-bs-toggle="modal" data-bs-target="#editNotesModal">
                        <i class="bi bi-pencil-fill me-2"></i> Edit Admin Notes
                    </button>
                {% endif %}
            </div>
        {% endif %}
    </div>

    <div class="text-center mt-5">
        <a href="{% url 'manage_applications' %}" class="btn btn-secondary-custom">
            <i class="bi bi-arrow-left me-1"></i> Back to All Applications
        </a>
    </div>

</div>

{# Modals for actions #}
{% if perms.institute.change_application %}
    {# Approve Modal #}
    <div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content modal-content-custom">
                <div class="modal-header modal-header-custom bg-success text-white" style="background-color: var(--success-color)!important;">
                    <h5 class="modal-title" id="approveModalLabel"><i class="bi bi-check-circle-fill me-2"></i> Approve Application</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body modal-body-custom">
                    <p class="lead mb-4">Are you sure you want to approve this application?</p>
                    <form id="approveForm" action="{% url 'approve_application' application.id %}" method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="approveNotes" class="form-label">Admin Notes (Optional):</label>
                            <textarea class="form-control form-control-custom" id="approveNotes" name="admin_notes" rows="4" placeholder="Add any relevant notes for approval..."></textarea>
                        </div>
                        <div class="text-end pt-3 border-top modal-footer-custom">
                            <button type="button" class="btn btn-secondary-custom me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success-custom"><i class="bi bi-check-lg me-1"></i> Confirm Approval</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# Reject Modal #}
    <div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content modal-content-custom">
                <div class="modal-header modal-header-custom bg-danger text-white" style="background-color: var(--error-color)!important;">
                    <h5 class="modal-title" id="rejectModalLabel"><i class="bi bi-x-circle-fill me-2"></i> Reject Application</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body modal-body-custom">
                    <p class="lead mb-4">Are you sure you want to reject this application? Please provide a clear reason.</p>
                    <form id="rejectForm" action="{% url 'reject_application' application.id %}" method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="rejectNotes" class="form-label">Admin Notes (Required for rejection):</label>
                            <textarea class="form-control form-control-custom" id="rejectNotes" name="admin_notes" rows="4" placeholder="e.g., Missing documents, Failed verification, etc." required></textarea>
                        </div>
                        <div class="text-end pt-3 border-top modal-footer-custom">
                            <button type="button" class="btn btn-secondary-custom me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger-custom"><i class="bi bi-x-lg me-1"></i> Confirm Rejection</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# Edit Notes Modal #}
    <div class="modal fade" id="editNotesModal" tabindex="-1" aria-labelledby="editNotesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content modal-content-custom">
                <div class="modal-header modal-header-custom bg-info text-white" style="background-color: var(--info-color)!important;">
                    <h5 class="modal-title" id="editNotesModalLabel"><i class="bi bi-pencil-fill me-2"></i> Edit Admin Notes</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body modal-body-custom">
                    <p class="lead mb-4">Edit the admin notes for this application.</p>
                    <form id="editNotesForm" action="{% url 'edit_application_notes' application.id %}" method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="editNotes" class="form-label">Admin Notes:</label>
                            <textarea class="form-control form-control-custom" id="editNotes" name="admin_notes" rows="4">{{ application.admin_notes|default_if_none:"" }}</textarea>
                        </div>
                        <div class="text-end pt-3 border-top modal-footer-custom">
                            <button type="button" class="btn btn-secondary-custom me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-info-custom"><i class="bi bi-save me-1"></i> Save Notes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endif %}

{% endblock %}
