# treebeard/templatetags/treebeard.py

from django import template

register = template.Library()

@register.tag
def recursetree(parser, token):
    """
    Template tag to help with recursive tree display.
    It takes a list of nodes and iterates through them. 
    If a node has children, the children are rendered using the same template 
    and returned in the 'children' context variable.
    """
    bits = token.contents.split()
    if len(bits) != 2:
        raise template.TemplateSyntaxError(
            "%r tag requires a single argument" % bits[0])

    # Everything between {% recursetree %} and {% endrecursetree %}
    nodelist = parser.parse(('endrecursetree',))
    parser.delete_first_token()

    return RecurseTreeNode(nodelist, bits[1])


class RecurseTreeNode(template.Node):
    def __init__(self, nodelist, queryset_var):
        self.nodelist = nodelist
        self.queryset_var = queryset_var

    def render(self, context):
        try:
            # Get the list of nodes from the context
            queryset = template.resolve_variable(self.queryset_var, context)
        except template.VariableDoesNotExist:
            return ''

        # The core logic: build the tree structure recursively
        output = []
        for node in queryset:
            children_list = list(node.get_children())
            
            # Pass children rendering result back to the template
            context.push()
            context['node'] = node
            
            # Recursively render children if they exist
            if children_list:
                context['children'] = RecurseTreeNode(
                    self.nodelist, 'children'
                ).render(context)
            else:
                context['children'] = ''
            
            output.append(self.nodelist.render(context))
            context.pop()
        
        # NOTE: This implementation is simplified for MP_Node's common usage.
        # It relies on the queryset passed being a list of root nodes or children.

        return ''.join(output)
